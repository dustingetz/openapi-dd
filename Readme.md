The goal of this due diligence is to achieve end-to-end understanding of OpenAPI-based web architecture, specifically targeted towards faceted search.

- [x] web client w/ React.js, swagger-js client driven by an OpenAPI spec
- [x] client talking to nodejs Express server, code-generated from an OpenAPI spec
- [x] mock server
- [ ] (WIP) get swagger-js working with mock server 
- [ ] More interesting sample data 
- [ ] OpenAPI spec for faceted search api
- [ ] serve sample from Elastic

Here is an example search request that seems representative of the wireframes (this is a real-world search request 
generated by Algolia search framework, but note there may be a simpler way to map this to OpenAPI):

```
?q=42mm
&idx=instant_search
&p=0
&dFR[brand][0]=Apple
&dFR[brand][1]=OtterBox
&dFR[free_shipping][0]=true
&hFR[hierarchicalCategories.lvl0][0]=Wearable Technology > Apple Watch > Apple Watch Series 1
&hFR[type][0]=Standard apple watch
```

## Findings

I only investigated tools that support OpenAPI 3. So far I evaluated: 
- two server code generators,
- one client library,
- two mock servers
- two OpenAPI spec examples: petstore.yaml & petstore-expanded.yaml

For the client Swagger-js seems good, it is a dynamic client (no code generation, spec loaded at runtime) and makes 
reasonable choices. Since swagger-js has been a good experience so far, I did not look into any other clients.

For the server side, both code generators I tried are very simple. 
- First I tried *swagger-codegen-cli* (the official code generator) which was very 
difficult to work with. I had to modify internals to get it working (to do this I had to set up a Typescript project). 
- These issues drove me to find *[openapi-generator-cli](https://github.com/OpenAPITools/openapi-generator)* which is a community fork of 
swagger-codegen-cli, see [Why was it decided to fork Swagger Codegen?](https://github.com/OpenAPITools/openapi-generator/blob/master/docs/qna.md). 
openapi-generator worked out-of-the-box.

Pros of server code generation:
- Shows how to wire things up
- There are a lot of wires, so this was quite helpful

Cons of server code generation:
- Generated code is not meant for production
- Generated code is very small stubs (seems meant to help newbies get started)
- Now that I understand how the server is wired up, there is no need for a generator
- Code is meant to be modified to add in your own service implementations
- Must regenerate the code every time the api spec changes
- Once you modify the generated code, it's challenging to regenerate it

Commercial tooling: requires further exploration

SAAS tooling: Requires further exploration



## OpenAPI background

OpenAPI has two versions, v2 ("Swagger Specification") and v3 ("OpenAPI") which was released in 2017. 
[source](https://swagger.io/blog/api-strategy/difference-between-swagger-and-openapi/)

Differences between v2 and v3:
- Simplified structure, increased reusability, standardized naming
- New features: links, callbacks
- Content negotiation
- Security minor changes (lessons learned)
- Parameter type improvements: cookie params, all param types can be complex; media type support
- OpenAPI Links: relations (static, not real hypermedia)
- Lots of breaking changes
- Not compatible with JSON Schema

v3.1 is coming. v3.1 will be convergent with the newest json schema draft and support arbitrary vocabulary extension.

The ecosystem is mostly divided by these v2/v3 breaking changes. Most libraries seem to target only one version, due to 
the major differences. So far it seems to be fine.

## How it works

```yaml
/store/inventory:
get:
  description: Returns a map of status codes to quantities
  operationId: getInventory
  responses:
    "200":
      content:
        application/json:
          schema:
            additionalProperties:
              format: int32
              type: integer
            type: object
      description: successful operation
  security:
  - api_key: []
  summary: Returns pet inventories by status
  tags:
  - store
  x-openapi-router-controller: StoreController
  x-openapi-router-service: StoreService
```

Key fields used by swagger-js client:
- operationId
- tags

Client code is like `client.apis.[tag].[operationId]()` e.g. `client.apis.store.getInventory()`

Key fields used by code generators:
- x-openapi-router-controller
- x-openapi-router-service

swagger-codegen-cli and openapi-generator-cli use these OpenAPI extension directives to name the generated files as well as wire them up.

Key fields used by mock servers:
- schema & schema/type
- examples (missing from below)

## dev stuff

React.js frontend
 
```shell script
cd web-client
yarn
npx parcel src/index.html
```

Node server 1, generated by swagger-codegen

```shell script
cd web-server
npm start

# http://localhost:8080/docs/
# http://localhost:8080/

# Generator incantation
wget https://repo1.maven.org/maven2/io/swagger/codegen/v3/swagger-codegen-cli/3.0.18/swagger-codegen-cli-3.0.18.jar -O swagger-codegen-cli.jar
java -jar swagger-codegen-cli.jar generate -l nodejs-server -i  
```

Node server 2 is like #1, but code pushed around to let me fork the generated server, needs typescript to compile

Node server 3, generated by openapi-generator, a hostile fork of swagger-codegen

```shell script
cd web-server3
node src/index

# Generator incantation
wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/4.2.3/openapi-generator-cli-4.2.3.jar -O openapi-generator-cli.jar
java -jar openapi-generator-cli.jar generate -g nodejs-express-server -i http://petstore.swagger.io/v2/swagger.json -o web-server3
```

mock-server-1
```shell script
npx open-api-mocker -s ../openapi.yaml -w
```

mock-server-2 (Prism)
```shell script
npx prism mock ../petstore-expanded.yaml
curl -s -D "/dev/stderr" http://127.0.0.1:4010/pets/123 | json_pp
```

Prism Docs:
- https://github.com/stoplightio/prism
- https://github.com/stoplightio/prism/blob/master/docs/getting-started/02-concepts.md
- https://github.com/stoplightio/prism/blob/master/docs/getting-started/03-cli.md
- https://github.com/stoplightio/prism/blob/master/docs/guides/01-mocking.md

Web server 4, which is like web server 3 but generated from petstore-expanded.yaml
```shell script
cd web-server4
node src/index

# Generator incantation
java -jar openapi-generator-cli.jar generate -g nodejs-express-server -i petstore-expanded.yaml -o web-server4
```